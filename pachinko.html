<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pachinko Simulator</title>
<style>
  body { margin:0; background:#000; display:flex; justify-content:center; align-items:center; height:100vh; color:#fff; font-family:monospace; }
  #container { text-align:center; }
  canvas { border-radius:10px; box-shadow:0 8px 30px rgba(0,0,0,0.6); display:block; margin:auto; }
  button { padding:8px 14px; border-radius:8px; font-weight:800; margin:0 4px; cursor:pointer; }
  #drop { background:#0f766e; color:#fff; }
  #reset { background:#2b2b2b; color:#fff; }
</style>
</head>
<body>
<div id="container">
  <div style="color:#ffd66b; font-weight:800; margin-bottom:8px;">Total Points</div>
  <div id="total" style="font-size:28px; margin-bottom:12px;">0</div>
  <canvas id="pachinko" width="640" height="840"></canvas>
  <div style="margin-top:12px;">
    <button id="drop">DROP</button>
    <button id="reset">RESET POINTS</button>
  </div>
  <div id="last" style="color:#9aa6b2; margin-top:10px; font-size:13px;">Last: —</div>
</div>

<script>
const canvas = document.getElementById('pachinko');
const ctx = canvas.getContext('2d');
const width = canvas.width, height = canvas.height;
const rows = 12, slotCount = rows + 1;
const STORAGE_KEY = 'pachinko.canvas.session.v6';

let displayTotal = 0, history = [], ball = null, dropping = false;

// Load saved data
try { 
  const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
  displayTotal = stored?.total || 0; 
  history = stored?.history || [];
} catch{}

document.getElementById('total').innerText = displayTotal;
if(history.length) document.getElementById('last').innerText = `Last: ${history[0].points}pts (slot ${history[0].slot})`;

// Initialize base scores
const baseScores = Array.from({ length: slotCount }, (_, i) => Math.max(1, 50 - Math.abs(i - (slotCount-1)/2)*8));

// Pegs: staggered grid
const pegs = [];
const margin = 24, topY=60, bottomY=height-140;
const pegCols = 10, pegRows = rows;
const rowSpacing = (bottomY-topY)/pegRows;
const colSpacing = (width-margin*2)/pegCols;
for(let r=0;r<pegRows;r++){
  for(let c=0;c<pegCols;c++){
    const offset = (r%2)*(colSpacing/2);
    const x = margin + c*colSpacing + offset + colSpacing/2;
    const y = topY + r*rowSpacing;
    pegs.push({x,y,r:7});
  }
}

// Audio
let audioCtx = null;
function ensureAudio(){ if(!audioCtx) try{audioCtx=new(window.AudioContext||window.webkitAudioContext)()}catch{}; return audioCtx; }
function plink(f=900,d=0.04){ const ctx=ensureAudio(); if(!ctx)return; const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.value=f*(0.9+Math.random()*0.2); g.gain.value=0.06; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d); o.stop(ctx.currentTime+d+0.01);}
function plonk(f=220,d=0.18){ const ctx=ensureAudio(); if(!ctx)return; const o=ctx.createOscillator(),g=ctx.createGain(); o.type='triangle'; o.frequency.value=f*(0.95+Math.random()*0.08); g.gain.value=0.12; o.connect(g); g.connect(ctx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001,ctx.currentTime+d); o.stop(ctx.currentTime+d+0.01);}

// Draw functions
function drawStatic(){
  ctx.fillStyle="#071021"; ctx.fillRect(0,0,width,height);
  for(const p of pegs){ ctx.beginPath(); ctx.fillStyle="#DDD"; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();}
  const slotTop=height-120, slotH=96, slotW=width/slotCount;
  ctx.fillStyle="#111"; ctx.fillRect(0,slotTop,width,slotH);
  ctx.strokeStyle="#2b2b2b";
  for(let i=0;i<slotCount;i++){
    ctx.strokeRect(i*slotW+6,slotTop+6,slotW-12,slotH-12);
    ctx.fillStyle="#cfcfcf"; ctx.font="bold 14px monospace"; ctx.textAlign="center"; ctx.fillText(i,i*slotW+slotW/2,slotTop+28);
    ctx.fillStyle="#ffd66b"; ctx.font="bold 18px monospace"; ctx.fillText(baseScores[i],i*slotW+slotW/2,slotTop+58);
  }
}

// Draw ball
function drawBall(){
  if(!ball) return;
  ctx.beginPath(); ctx.fillStyle="#ffb347"; ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fill();
}

// Physics
function simulatePhysics(dt){
  if(!ball) return;
  const g=900; ball.vy+=g*dt; ball.vx*=Math.pow(0.999,dt*60); ball.vy*=Math.pow(0.999,dt*60); ball.x+=ball.vx*dt; ball.y+=ball.vy*dt;
  const lb=8, rb=width-8;
  if(ball.x-ball.r<lb){ ball.x=lb+ball.r; ball.vx=Math.abs(ball.vx)*0.6; ball.vy*=0.9;}
  if(ball.x+ball.r>rb){ ball.x=rb-ball.r; ball.vx=-Math.abs(ball.vx)*0.6; ball.vy*=0.9;}
  for(const p of pegs){
    const dx=ball.x-p.x, dy=ball.y-p.y, dist=Math.sqrt(dx*dx+dy*dy), minD=ball.r+p.r;
    if(dist<minD && dist>0){
      const nx=dx/dist, ny=dy/dist, rel=ball.vx*nx+ball.vy*ny;
      ball.vx-=(1.8*rel)*nx; ball.vy-=(1.8*rel)*ny; ball.vx+=(Math.random()-0.5)*20;
      const overlap=minD-dist+0.5; ball.x+=nx*overlap; ball.y+=ny*overlap;
      plink(800-(p.y/height)*300,0.03);
    }
  }
  const st=height-120;
  if(ball.y+ball.r>=st){
    const idx=Math.min(slotCount-1,Math.max(0,Math.floor(ball.x/(width/slotCount))));
    ball.x=idx*(width/slotCount)+(width/slotCount)/2; ball.y=height-60; ball.vx=0; ball.vy=0; ball.restingSlot=idx; dropping=false;
    plonk(200+Math.random()*60,0.24); setTimeout(()=>revealScore(idx),750);
  }
}

// Reveal score and save
function revealScore(idx){
  const pts=baseScores[idx]||0;
  const start=displayTotal, end=start+pts;
  const dur=900, t0=performance.now();
  function tick(now){
    const p=Math.min(1,(now-t0)/dur);
    displayTotal=Math.floor(start+(end-start)*(1-Math.pow(1-p,2)));
    document.getElementById('total').innerText=displayTotal;
    if(p<1) requestAnimationFrame(tick);
    else {
      history.unshift({slot:idx,points:pts,ts:new Date().toISOString()});
      history=history.slice(0,200);
      document.getElementById('last').innerText=`Last: ${pts}pts (slot ${idx})`;
      localStorage.setItem(STORAGE_KEY, JSON.stringify({total:displayTotal,history}));
      drawStatic();
      drawBall();
    }
  }
  requestAnimationFrame(tick);
}

// Render loop
function render(){
  drawStatic();
  drawBall();
  if(dropping) requestAnimationFrame(render);
}

// Start drop
document.getElementById('drop').addEventListener('click', ()=>{
  if(dropping) return;
  ball={x:width/2, y:28, vx:(Math.random()-0.5)*6, vy:0, r:10, restingSlot:null};
  dropping=true;
  ensureAudio();
  const last={t:performance.now()};
  function step(now){
    const dt=Math.min(32,now-last.t)/1000; last.t=now;
    simulatePhysics(dt);
    render();
    if(dropping) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
});

// Reset points
document.getElementById('reset').addEventListener('click', ()=>{
  displayTotal=0; history=[]; ball=null; dropping=false;
  localStorage.removeItem(STORAGE_KEY);
  document.getElementById('total').innerText=displayTotal;
  document.getElementById('last').innerText='Last: —';
  drawStatic();
});

// Initial draw
drawStatic();
if(history.length && history[0].slot!=null){
  ball={x:history[0].slot*(width/slotCount)+(width/slotCount)/2, y:height-60, r:10, restingSlot:history[0].slot};
  drawBall();
}
</script>
</body>
</html>
