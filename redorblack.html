<script>
// Spin logic
document.getElementById('spin').addEventListener('click', ()=>{
  if(spinning || !selectedColor) return;
  betAmount = parseInt(document.getElementById('bet').value)||5;
  if(betAmount>chips) betAmount=chips;
  if(betAmount<=0) return;
  spinning=true;
  chips-=betAmount; document.getElementById('chips').innerText=chips;

  const segments=36;
  let ballAngle = Math.random()*2*Math.PI; // start angle
  const spinDur = 3000 + Math.random()*1000; 
  const start = performance.now();

  function animate(now){
    const t=(now-start)/spinDur;
    const ease = Math.min(1, t);
    ballAngle += 0.05*(1-ease); // fast first, slow down
    drawPolishedWheel(); // improved wheel design
    // Ball
    const ballR = 14;
    const ballX = center.x + Math.cos(ballAngle)*(radius-30);
    const ballY = center.y + Math.sin(ballAngle)*(radius-30);
    const grad = ctx.createRadialGradient(ballX,ballY,2,ballX,ballY,ballR);
    grad.addColorStop(0,'#fff2b2'); grad.addColorStop(0.5,'#ffd66b'); grad.addColorStop(1,'#ff8c00');
    ctx.fillStyle=grad;
    ctx.beginPath(); ctx.arc(ballX,ballY,ballR,0,Math.PI*2); ctx.fill();

    if(t<1) requestAnimationFrame(animate);
    else finish();
  }

  function finish(){
    // Snap ballAngle to nearest slot center
    const slotAngle = (2*Math.PI)/segments;
    const snappedIndex = Math.round(ballAngle/slotAngle)%segments;
    const color = snappedIndex%2===0?'red':'black';
    const win = (color===selectedColor);
    const result = win?betAmount*2:0;
    if(win) chips+=result;

    // Limits and lockout
    if(chips>=200 || chips<=0){
      if(chips>=200) chips=200;
      if(chips<=0) chips=0;
      document.getElementById('spin').disabled=true;
      const unlock = new Date(Date.now()+24*60*60*1000);
      lockUntil = unlock.getTime();
    }

    document.getElementById('chips').innerText = chips;
    history.unshift({color,bet:betAmount,win,result});
    history = history.slice(0,200);
    updateHistory();
    localStorage.setItem(STORAGE_KEY, JSON.stringify({chips,history,lockUntil}));
    spinning=false;
  }

  requestAnimationFrame(animate);
});

// Improved wheel drawing
function drawPolishedWheel(){
  ctx.clearRect(0,0,width,height);
  const segments=36;
  for(let i=0;i<segments;i++){
    const start=(i*(2*Math.PI/segments));
    const end=((i+1)*(2*Math.PI/segments));
    ctx.beginPath();
    ctx.moveTo(center.x,center.y);
    ctx.arc(center.x,center.y,radius,start,end);
    // Gradient for more depth
    const grad = ctx.createRadialGradient(center.x,center.y,20,center.x,center.y,radius);
    grad.addColorStop(0,'#222'); grad.addColorStop(0.5,i%2===0?'#ff4d4d':'#111'); grad.addColorStop(1,'#111');
    ctx.fillStyle=grad;
    ctx.fill();
    ctx.strokeStyle='#111';
    ctx.lineWidth=2;
    ctx.stroke();
  }
  // Center circle
  ctx.beginPath();
  ctx.arc(center.x,center.y,30,0,2*Math.PI);
  ctx.fillStyle='#071021';
  ctx.shadowColor='#000';
  ctx.shadowBlur=10;
  ctx.fill();
  ctx.shadowBlur=0;
}
</script>
