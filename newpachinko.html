<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pachinko Simulator</title>
<style>
  body { margin:0; background:#071021; display:flex; justify-content:center; align-items:center; height:100vh; }
  canvas { background:#071021; border-radius:12px; }
  #timer { position:absolute; top:12px; left:12px; color:#ffd66b; font-family:monospace; font-weight:800; font-size:16px; }
  #total { position:absolute; top:12px; right:12px; color:#ffd66b; font-family:monospace; font-weight:800; font-size:16px; }
</style>
</head>
<body>
<div id="timer">Reset in 12:00:00</div>
<div id="total">Points: 0</div>
<canvas id="board" width="640" height="840"></canvas>
<script>
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const width = canvas.width, height = canvas.height;
const STORAGE_KEY = 'pachinko.html.v1';
const RESET_INTERVAL = 12*60*60*1000;

let slots = 13;
let baseScores = Array.from({length:slots}, (_,i)=> Math.max(1,50-Math.abs(i-(slots-1)/2)*8));
let pegs = [];
let ball = null;
let dropping = false;
let displayTotal = 0;
let history = [];
let lastReset = Date.now();

// Load storage and handle reset
try{
  const stored = JSON.parse(localStorage.getItem(STORAGE_KEY));
  if(stored){
    if(Date.now() - stored.lastReset >= RESET_INTERVAL){
      displayTotal=0; history=[]; lastReset=Date.now();
    } else { displayTotal=stored.total||0; history=stored.history||[]; lastReset=stored.lastReset||Date.now(); }
  }
}catch{}
document.getElementById('total').innerText = 'Points: '+displayTotal;

// Timer
function updateTimer(){
  let remaining = RESET_INTERVAL - (Date.now()-lastReset);
  if(remaining<=0){displayTotal=0;history=[];lastReset=Date.now();localStorage.setItem(STORAGE_KEY,JSON.stringify({total:0,history:[],lastReset:lastReset}));}
  remaining = Math.max(0,remaining);
  const hrs=Math.floor(remaining/3600000);
  const mins=Math.floor((remaining%3600000)/60000);
  const secs=Math.floor((remaining%60000)/1000);
  document.getElementById('timer').innerText = `Reset in ${hrs.toString().padStart(2,'0')}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
  requestAnimationFrame(updateTimer);
}
updateTimer();

// Create pegs triangle
function createPegs(){
  const rows=12, margin=24, topY=60, bottomY=height-140;
  const usableW = width-margin*2;
  pegs=[];
  for(let r=0;r<rows;r++){
    const count=r+1, rowWidth=usableW*count/rows, offsetX=margin+(usableW-rowWidth)/2, stepX=rowWidth/count;
    for(let c=0;c<count;c++){
      let x=offsetX+stepX*(c+0.5);
      let y=topY+(r/(rows-1))*(bottomY-topY);
      if(r===0)x=width/2;
      pegs.push({x,y,r:7});
    }
  }
}
createPegs();

// Draw static board
function drawBoard(){
  ctx.fillStyle='#071021';ctx.fillRect(0,0,width,height);
  for(const p of pegs){ctx.beginPath();ctx.fillStyle='#DDD';ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();}
  const slotTop=height-120, slotH=96, slotW=width/slots;
  ctx.fillStyle='#111'; ctx.fillRect(0,slotTop,width,slotH);
  ctx.strokeStyle='#2b2b2b';
  for(let i=0;i<slots;i++){
    ctx.strokeRect(i*slotW+6,slotTop+6,slotW-12,slotH-12);
    ctx.fillStyle='#cfcfcf'; ctx.font='bold 14px monospace'; ctx.textAlign='center'; ctx.fillText(`${i}`,i*slotW+slotW/2,slotTop+28);
    ctx.fillStyle='#ffd66b'; ctx.font='bold 18px monospace'; ctx.fillText(`${baseScores[i]}`,i*slotW+slotW/2,slotTop+58);
  }
}
drawBoard();

function drawBall(){
  if(!ball)return;
  ctx.beginPath(); ctx.fillStyle='#ffb347'; ctx.arc(ball.x,ball.y,ball.r,0,Math.PI*2); ctx.fill();
}

function startDrop(){
  if(dropping)return;
  ball={x:width/2,y:28,vx:(Math.random()-0.5)*8,vy:0,r:10};
  dropping=true;
  const step = ()=>{
    if(!ball)return;
    const dt=1/60, g=900;
    ball.vy+=g*dt; ball.vx*=0.999; ball.vy*=0.999;
    ball.x+=ball.vx*dt*60; ball.y+=ball.vy*dt*60;
    const lb=8, rb=width-8;
    if(ball.x-ball.r<lb){ball.x=lb+ball.r;ball.vx=Math.abs(ball.vx)*0.6;} 
    if(ball.x+ball.r>rb){ball.x=rb-ball.r;ball.vx=-Math.abs(ball.vx)*0.6;}
    for(const p of pegs){
      const dx=ball.x-p.x, dy=ball.y-p.y, dist=Math.sqrt(dx*dx+dy*dy), minD=ball.r+p.r;
      if(dist<minD && dist>0){const nx=dx/dist, ny=dy/dist, rel=ball.vx*nx+ball.vy*ny;ball.vx-=(1.9*rel)*nx; ball.vy-=(1.9*rel)*ny; const overlap=minD-dist+0.5; ball.x+=nx*overlap; ball.y+=ny*overlap;}
    }
    const st=height-120; if(ball.y+ball.r>=st){
      const idx=Math.min(slots-1,Math.max(0,Math.floor(ball.x/(width/slots))));
      displayTotal+=baseScores[idx];
      document.getElementById('total').innerText = 'Points: '+displayTotal;
      localStorage.setItem(STORAGE_KEY,JSON.stringify({total:displayTotal,history, lastReset}));
      dropping=false; ball=null; return;
    }
    drawBoard(); drawBall();
    if(dropping) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

canvas.addEventListener('click',startDrop);
</script>
</body>
</html>
